[
  {
    "id": "system_a_recovery_rule",
    "system": "system_a",
    "metric": "recovery",
    "target_entity": "payment",
    "target_grain": ["uuid"],
    "computation": {
      "description": "Recovery calculation from System A repayments table",
      "source_entities": ["payment"],
      "source_table": "repayments",
      "attributes_needed": {
        "payment": ["user_uuid", "total_amount", "created_at"]
      },
      "formula": "sum(total_amount)",
      "aggregation_grain": ["user_uuid"],
      "filter_conditions": {
        "created_at": "IS NOT NULL",
        "total_amount": "IS NOT NULL",
        "__is_deleted": "= false",
        "status": "IN ('SUCCESS', 'IN_PROGRESS')"
      },
      "note": "Maps user_uuid to uuid, total_amount to paid_amount, created_at to paid_date. Excludes deleted and failed payments."
    },
    "labels": ["recovery", "payments", "system_a"]
  },
  {
    "id": "system_b_recovery_rule",
    "system": "system_b",
    "metric": "recovery",
    "target_entity": "payment",
    "target_grain": ["uuid"],
    "computation": {
      "description": "Recovery calculation from System B EMI payments",
      "source_entities": ["payment"],
      "source_table": "lmsdata_emi_payment_view",
      "attributes_needed": {
        "payment": ["uuid", "paid_amount", "payment_date"]
      },
      "formula": "sum(paid_amount)",
      "aggregation_grain": ["uuid"],
      "filter_conditions": {
        "payment_date": "IS NOT NULL",
        "paid_amount": "IS NOT NULL",
        "is_deleted": "= false"
      },
      "note": "Direct mapping: uuid, paid_amount, payment_date. Excludes deleted records."
    },
    "labels": ["recovery", "payments", "system_b"]
  },
  {
    "id": "system_a_collections_recovery_rule",
    "system": "system_a",
    "metric": "recovery",
    "target_entity": "collection",
    "target_grain": ["uuid"],
    "computation": {
      "description": "Recovery calculation from System A collections report",
      "source_entities": ["collection"],
      "source_table": "current_month_collection_report",
      "attributes_needed": {
        "collection": ["uuid", "paid_amount", "paid_date"]
      },
      "formula": "sum(paid_amount)",
      "aggregation_grain": ["uuid"],
      "filter_conditions": {
        "paid_date": "IS NOT NULL",
        "paid_amount": "IS NOT NULL"
      },
      "note": "Collections MIS recovery calculation. Uses uuid, paid_amount, paid_date."
    },
    "labels": ["recovery", "collections", "system_a", "mis"]
  },
  {
    "id": "system_a_outstanding_rule",
    "system": "system_a",
    "metric": "outstanding",
    "target_entity": "loan",
    "target_grain": ["uuid", "order_id"],
    "computation": {
      "description": "Outstanding calculation from System A daily snapshot",
      "source_entities": ["loan"],
      "source_table": "outstanding_daily",
      "attributes_needed": {
        "loan": ["uuid", "order_id", "principal_outstanding", "interest_outstanding", "last_day"]
      },
      "formula": "sum(principal_outstanding + interest_outstanding)",
      "aggregation_grain": ["uuid", "order_id"],
      "filter_conditions": {
        "last_day": "IS NOT NULL",
        "principal_outstanding": "IS NOT NULL",
        "interest_outstanding": "IS NOT NULL"
      },
      "note": "Total outstanding = principal + interest. Snapshot at last_day grain."
    },
    "labels": ["outstanding", "loan", "system_a"]
  },
  {
    "id": "system_a_writeoff_provisional_rule",
    "system": "system_a",
    "metric": "writeoff",
    "target_entity": "writeoff",
    "target_grain": ["uuid", "order_id"],
    "computation": {
      "description": "Provisional writeoff calculation from System A",
      "source_entities": ["writeoff"],
      "source_table": "provisional_writeoff",
      "attributes_needed": {
        "writeoff": ["uuid", "order_id", "principal_outstanding", "interest_outstanding", "writeoff_date"]
      },
      "formula": "sum(principal_outstanding + interest_outstanding)",
      "aggregation_grain": ["uuid", "order_id"],
      "filter_conditions": {
        "writeoff_date": "IS NOT NULL",
        "principal_outstanding": "IS NOT NULL",
        "interest_outstanding": "IS NOT NULL"
      },
      "note": "Provisional writeoff amount = principal + interest outstanding at writeoff date."
    },
    "labels": ["writeoff", "provisional", "system_a"]
  },
  {
    "id": "system_a_writeoff_users_rule",
    "system": "system_a",
    "metric": "writeoff",
    "target_entity": "writeoff",
    "target_grain": ["uuid", "order_id"],
    "computation": {
      "description": "User writeoff calculation from System A",
      "source_entities": ["writeoff"],
      "source_table": "writeoff_users",
      "attributes_needed": {
        "writeoff": ["uuid", "order_id", "amt", "writeoff_date"]
      },
      "formula": "sum(amt)",
      "aggregation_grain": ["uuid", "order_id"],
      "filter_conditions": {
        "writeoff_date": "IS NOT NULL",
        "amt": "IS NOT NULL"
      },
      "note": "User-level writeoff amount from writeoff_users table."
    },
    "labels": ["writeoff", "users", "system_a"]
  },
  {
    "id": "system_a_da_orders_rule",
    "system": "system_a",
    "metric": "da_pos",
    "target_entity": "order",
    "target_grain": ["order_id", "uuid"],
    "computation": {
      "description": "DA orders POS calculation from System A",
      "source_entities": ["order"],
      "source_table": "da_orders",
      "attributes_needed": {
        "order": ["order_id", "uuid", "pos_on_da_date", "da_date"]
      },
      "formula": "sum(pos_on_da_date)",
      "aggregation_grain": ["order_id", "uuid"],
      "filter_conditions": {
        "da_date": "IS NOT NULL",
        "pos_on_da_date": "IS NOT NULL"
      },
      "note": "Principal outstanding on delegation of authority date."
    },
    "labels": ["da", "orders", "securitization", "system_a"]
  },
  {
    "id": "system_b_principal_paid_rule",
    "system": "system_b",
    "metric": "principal_recovery",
    "target_entity": "payment",
    "target_grain": ["uuid"],
    "computation": {
      "description": "Principal recovery from System B EMI payments",
      "source_entities": ["payment"],
      "source_table": "lmsdata_emi_payment_view",
      "attributes_needed": {
        "payment": ["uuid", "principal_paid", "payment_date"]
      },
      "formula": "sum(principal_paid)",
      "aggregation_grain": ["uuid"],
      "filter_conditions": {
        "payment_date": "IS NOT NULL",
        "principal_paid": "IS NOT NULL",
        "is_deleted": "= false"
      },
      "note": "Principal amount recovered from EMI payments."
    },
    "labels": ["recovery", "principal", "payments", "system_b"]
  },
  {
    "id": "system_b_interest_paid_rule",
    "system": "system_b",
    "metric": "interest_recovery",
    "target_entity": "payment",
    "target_grain": ["uuid"],
    "computation": {
      "description": "Interest recovery from System B EMI payments",
      "source_entities": ["payment"],
      "source_table": "lmsdata_emi_payment_view",
      "attributes_needed": {
        "payment": ["uuid", "interest_paid", "payment_date"]
      },
      "formula": "sum(interest_paid)",
      "aggregation_grain": ["uuid"],
      "filter_conditions": {
        "payment_date": "IS NOT NULL",
        "interest_paid": "IS NOT NULL",
        "is_deleted": "= false"
      },
      "note": "Interest amount recovered from EMI payments."
    },
    "labels": ["recovery", "interest", "payments", "system_b"]
  }
]

