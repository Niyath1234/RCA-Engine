[
  {
    "id": "bank_region_rule",
    "system": "s3_tool_propagator",
    "metric": "region",
    "target_entity": "loan",
    "description": "Region classification for Bank products: OS if branch_code is 333 for EDL products, otherwise NE",
    "computation": {
      "description": "For EDL products, region is OS if branch_code = 333, else NE. For other bank products, region is always NE",
      "source_table": "nondigital_adh433_v1",
      "formula": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs','7606/7607/7608  - enterprise development loan (buss)','term_loan_to_fi') THEN CASE WHEN branch_code = 333 THEN 'OS' ELSE 'NE' END ELSE 'NE' END",
      "filter_conditions": {}
    }
  },
  {
    "id": "bank_product_group_rule",
    "system": "s3_tool_propagator",
    "metric": "product_group",
    "target_entity": "loan",
    "description": "Product group classification for Bank products",
    "computation": {
      "description": "Classify bank products into EDL, CC, OD/TD, term_loan_to_fi, or Other products",
      "source_table": "nondigital_adh433_v1",
      "formula": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs', '7606/7607/7608  - enterprise development loan (buss)') THEN 'EDL' WHEN product_name = 'Cash Credit' THEN 'CC' WHEN lower(product_name) like '%overdraft against term deposit%' THEN 'OD/TD' WHEN lower(product_name) = 'term_loan_to_fi' THEN 'term_loan_to_fi' ELSE 'Other products' END",
      "filter_conditions": {}
    }
  },
  {
    "id": "bank_reportdate_rule",
    "system": "s3_tool_propagator",
    "metric": "reportdate",
    "target_entity": "loan",
    "description": "Default report date for Bank products is yesterday",
    "computation": {
      "description": "Report date should be yesterday's date",
      "source_table": "nondigital_adh433_v1",
      "formula": "CAST(DATE_FORMAT(DATE_SUB(CURRENT_DATE, 1), 'yyyy-MM-dd') AS STRING)",
      "filter_conditions": {
        "reportdate": "CAST(DATE_FORMAT(DATE_SUB(CURRENT_DATE, 1), 'yyyy-MM-dd') AS STRING)"
      }
    }
  },
  {
    "id": "digital_order_type_rule",
    "system": "s3_tool_propagator",
    "metric": "order_type",
    "target_entity": "loan",
    "description": "Order type classification for Digital products: 'credin' stays as 'credin', others become 'Digital'",
    "computation": {
      "description": "If order_type is 'credin', keep as 'credin', otherwise classify as 'Digital'",
      "source_table": "outstanding_daily",
      "formula": "CASE WHEN LOWER(order_type) = 'credin' THEN 'credin' ELSE 'Digital' END",
      "filter_conditions": {}
    }
  },
  {
    "id": "digital_exclusion_rule",
    "system": "s3_tool_propagator",
    "metric": "exclusion",
    "target_entity": "loan",
    "description": "Exclude credit_card and no_cost_emi from Digital products",
    "computation": {
      "description": "Digital products exclude credit_card and no_cost_emi order types",
      "source_table": "outstanding_daily",
      "filter_conditions": {
        "order_type": "NOT IN ('credit_card','no_cost_emi')"
      }
    }
  },
  {
    "id": "da_adjustment_rule",
    "system": "s3_tool_propagator",
    "metric": "current_pos",
    "target_entity": "loan",
    "description": "DA adjustment factor for outstanding amounts: 0.01 for Feb 2024, 0.05 for other months, 1.0 if no DA date",
    "computation": {
      "description": "Apply DA adjustment factor based on DA date month",
      "source_table": "outstanding_daily",
      "formula": "CASE WHEN DATE_TRUNC('month', DATE(da_date)) = DATE '2024-02-01' THEN principal_outstanding * 0.01 WHEN DATE_TRUNC('month', DATE(da_date)) IS NULL THEN principal_outstanding ELSE principal_outstanding * 0.05 END",
      "joins": [
        {
          "table": "da_orders",
          "on": "da_orders.order_id = outstanding_daily.order_id",
          "type": "LEFT"
        }
      ]
    }
  },
  {
    "id": "writeoff_exclusion_rule",
    "system": "s3_tool_propagator",
    "metric": "exclusion",
    "target_entity": "loan",
    "description": "Exclude orders that are in writeoff_users or provisional_writeoff tables",
    "computation": {
      "description": "Exclude orders present in writeoff or provisional writeoff tables",
      "source_table": "outstanding_daily",
      "filter_conditions": {
        "writeoff_users.order_id": "IS NULL",
        "provisional_writeoff.order_id": "IS NULL"
      },
      "joins": [
        {
          "table": "writeoff_users",
          "on": "writeoff_users.order_id = outstanding_daily.order_id",
          "type": "LEFT"
        },
        {
          "table": "provisional_writeoff",
          "on": "provisional_writeoff.order_id = outstanding_daily.order_id",
          "type": "LEFT"
        }
      ]
    }
  },
  {
    "id": "unsettled_filter_rule",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Include only unsettled loans",
    "computation": {
      "description": "Filter to include only loans with settlement_flag = 'unsettled'",
      "source_table": "outstanding_daily",
      "filter_conditions": {
        "settlement_flag": "unsettled"
      }
    }
  },
  {
    "id": "nbfc_filter_rule",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Filter for specific NBFCs: quadrillion, slicenesfb, nesfb",
    "computation": {
      "description": "Include only loans from quadrillion, slicenesfb, or nesfb NBFCs",
      "source_table": "outstanding_daily",
      "formula": "COALESCE(nbfc_name_colending, parent_nbfc_name) IN ('quadrillion', 'slicenesfb', 'nesfb')",
      "filter_conditions": {
        "nbfc": "IN ('quadrillion', 'slicenesfb', 'nesfb')"
      }
    }
  },
  {
    "id": "digital_reportdate_rule",
    "system": "s3_tool_propagator",
    "metric": "reportdate",
    "target_entity": "loan",
    "description": "Default report date for Digital products is two days before current date",
    "computation": {
      "description": "Last day should be two days before current date",
      "source_table": "outstanding_daily",
      "formula": "DATE(DATEADD(DAY, -2, CURRENT_DATE))",
      "filter_conditions": {
        "last_day": "DATE(DATEADD(DAY, -2, CURRENT_DATE))"
      }
    }
  },
  {
    "id": "khatabook_writeoff_filter",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Exclude written off Khatabook loans",
    "computation": {
      "description": "Include only loans where write_off_flag = 'N'",
      "source_table": "kb_adh433",
      "filter_conditions": {
        "write_off_flag": "N"
      }
    }
  },
  {
    "id": "khatabook_arc_filter",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Exclude ARC cases from Khatabook products",
    "computation": {
      "description": "Include only if arc_flag IS NULL OR arc_flag = 'N' OR arc_flag = 'NULL'",
      "source_table": "kb_adh433",
      "formula": "(arc_flag IS NULL OR arc_flag = 'N' OR arc_flag = 'NULL')",
      "filter_conditions": {
        "arc_flag": "IN (NULL, 'N', 'NULL')"
      }
    }
  },
  {
    "id": "khatabook_settled_filter",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Include only unsettled Khatabook loans",
    "computation": {
      "description": "Include only loans where settled_flag = 'N'",
      "source_table": "kb_adh433",
      "filter_conditions": {
        "settled_flag": "N"
      }
    }
  },
  {
    "id": "khatabook_originator_filter",
    "system": "s3_tool_propagator",
    "metric": "filter",
    "target_entity": "loan",
    "description": "Include only Khatabook originated loans",
    "computation": {
      "description": "Include only if originator IS NULL OR LOWER(TRIM(originator)) = 'khatabook'",
      "source_table": "kb_adh433",
      "formula": "(originator IS NULL OR LOWER(TRIM(originator)) = 'khatabook')",
      "filter_conditions": {
        "originator": "IS NULL OR LOWER(TRIM(originator)) = 'khatabook'"
      }
    }
  },
  {
    "id": "khatabook_reportdate_rule",
    "system": "s3_tool_propagator",
    "metric": "reportdate",
    "target_entity": "loan",
    "description": "Default report date for Khatabook products is yesterday",
    "computation": {
      "description": "Report date should be yesterday's date",
      "source_table": "kb_adh433",
      "formula": "DATE(DATEADD(DAY, -1, CURRENT_DATE))",
      "filter_conditions": {
        "reportdate": "DATE(DATEADD(DAY, -1, CURRENT_DATE))"
      }
    }
  },
  {
    "id": "khatabook_current_pos_rule",
    "system": "s3_tool_propagator",
    "metric": "current_pos",
    "target_entity": "loan",
    "description": "Current position calculation for Khatabook: absolute value of sum of ledger balance divided by 1e7, rounded to 4 decimals",
    "computation": {
      "description": "Calculate current position as ABS(ROUND(SUM(leadger_balance) / 1e7, 4))",
      "source_table": "kb_adh433",
      "formula": "ABS(ROUND(SUM(CAST(leadger_balance AS DOUBLE)) / 1e7, 4))",
      "aggregation": "sum"
    }
  },
  {
    "id": "da_reportdate_rule",
    "system": "s3_tool_propagator",
    "metric": "reportdate",
    "target_entity": "loan",
    "description": "Default report date for DA products is maximum reportdate before current date",
    "computation": {
      "description": "Report date should be the maximum reportdate that is less than current date",
      "source_table": "da_adh433",
      "formula": "(SELECT MAX(reportdate) FROM da_adh433 WHERE reportdate < CURRENT_DATE)",
      "filter_conditions": {
        "reportdate": "(SELECT MAX(reportdate) FROM da_adh433 WHERE reportdate < CURRENT_DATE)"
      }
    }
  },
  {
    "id": "da_partner_name_rule",
    "system": "s3_tool_propagator",
    "metric": "order_type",
    "target_entity": "loan",
    "description": "Order type for DA products is the capitalized and trimmed partner name",
    "computation": {
      "description": "Order type is INITCAP(TRIM(partner_name))",
      "source_table": "da_adh433",
      "formula": "INITCAP(TRIM(partner_name))"
    }
  }
]

