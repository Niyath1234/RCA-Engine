{
  "relationships": [
    {
      "from_table": "outstanding_daily",
      "to_table": "da_orders",
      "relationship_type": "one_to_one",
      "join_condition": "outstanding_daily.order_id = da_orders.order_id",
      "join_type": "LEFT",
      "description": "Join to get DA date for outstanding loans",
      "required_for": ["digital", "credit_card"]
    },
    {
      "from_table": "outstanding_daily",
      "to_table": "writeoff_users",
      "relationship_type": "one_to_one",
      "join_condition": "outstanding_daily.order_id = writeoff_users.order_id",
      "join_type": "LEFT",
      "description": "Join to exclude written off loans",
      "required_for": ["digital", "credit_card"],
      "exclusion": true
    },
    {
      "from_table": "outstanding_daily",
      "to_table": "provisional_writeoff",
      "relationship_type": "one_to_one",
      "join_condition": "outstanding_daily.order_id = provisional_writeoff.order_id",
      "join_type": "LEFT",
      "description": "Join to exclude provisionally written off loans",
      "required_for": ["digital", "credit_card"],
      "exclusion": true
    }
  ],
  "table_groups": {
    "bank_products": {
      "primary_table": "nondigital_adh433_v1",
      "description": "Bank products group",
      "tables": ["nondigital_adh433_v1"]
    },
    "digital_products": {
      "primary_table": "outstanding_daily",
      "description": "Digital products group including Credin",
      "tables": ["outstanding_daily", "da_orders", "writeoff_users", "provisional_writeoff"],
      "required_joins": ["da_orders"],
      "exclusion_joins": ["writeoff_users", "provisional_writeoff"]
    },
    "credit_card_products": {
      "primary_table": "outstanding_daily",
      "description": "Credit card products group",
      "tables": ["outstanding_daily", "da_orders", "writeoff_users", "provisional_writeoff"],
      "required_joins": ["da_orders"],
      "exclusion_joins": ["writeoff_users", "provisional_writeoff"]
    },
    "khatabook_products": {
      "primary_table": "kb_adh433",
      "description": "Khatabook products group",
      "tables": ["kb_adh433"]
    },
    "da_products": {
      "primary_table": "da_adh433",
      "description": "DA (Deferred Annuity) products group",
      "tables": ["da_adh433"]
    }
  },
  "business_rules": {
    "bank": {
      "description": "Bank products reporting rules",
      "default_filters": {
        "reportdate": "Yesterday's date"
      },
      "group_by": ["order_type", "region", "product_group"],
      "aggregation": "SUM(final_outstanding)"
    },
    "digital": {
      "description": "Digital products reporting rules",
      "default_filters": {
        "settlement_flag": "unsettled",
        "last_day": "Two days before current date",
        "nbfc": "IN ('quadrillion', 'slicenesfb', 'nesfb')",
        "order_type": "NOT IN ('credit_card', 'no_cost_emi')"
      },
      "exclusions": {
        "writeoff_users": "order_id IS NULL",
        "provisional_writeoff": "order_id IS NULL"
      },
      "group_by": ["order_type", "region", "product_group"],
      "aggregation": "SUM(da_adjusted_outstanding)"
    },
    "credit_card": {
      "description": "Credit card products reporting rules",
      "default_filters": {
        "settlement_flag": "unsettled",
        "last_day": "Two days before current date",
        "nbfc": "IN ('quadrillion', 'slicenesfb', 'nesfb')",
        "order_type": "IN ('credit_card', 'no_cost_emi')"
      },
      "exclusions": {
        "writeoff_users": "order_id IS NULL",
        "provisional_writeoff": "order_id IS NULL"
      },
      "group_by": ["order_type", "region", "product_group"],
      "aggregation": "SUM(da_adjusted_outstanding)"
    },
    "khatabook": {
      "description": "Khatabook products reporting rules",
      "default_filters": {
        "write_off_flag": "N",
        "arc_flag": "IN (NULL, 'N', 'NULL')",
        "settled_flag": "N",
        "originator": "IS NULL OR LOWER(TRIM(originator)) = 'khatabook'",
        "reportdate": "Yesterday's date"
      },
      "group_by": ["order_type", "region", "product_group"],
      "aggregation": "ABS(ROUND(SUM(leadger_balance) / 1e7, 4))"
    },
    "da": {
      "description": "DA products reporting rules",
      "default_filters": {
        "reportdate": "Maximum reportdate before current date"
      },
      "group_by": ["order_type", "region", "product_group"],
      "aggregation": "SUM(leadger_balance)"
    }
  }
}

