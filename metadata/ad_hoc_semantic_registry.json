{
  "metrics": [
    {
      "name": "current_pos",
      "description": "Current Position - total outstanding amount for a product group and region",
      "aggregation": "sum",
      "base_table": "varies_by_product",
      "grain": "none",
      "sql_expression": "varies_by_product",
      "allowed_dimensions": ["order_type", "region", "product_group"],
      "required_filters": [],
      "product_specific": {
        "bank": {
          "base_table": "nondigital_adh433_v1",
          "sql_expression": "SUM(CAST(final_outstanding AS DOUBLE))"
        },
        "digital": {
          "base_table": "outstanding_daily",
          "sql_expression": "SUM(CASE WHEN DATE_TRUNC('month', DATE(da_date)) = DATE '2024-02-01' THEN principal_outstanding * 0.01 WHEN DATE_TRUNC('month', DATE(da_date)) IS NULL THEN principal_outstanding ELSE principal_outstanding * 0.05 END)",
          "requires_join": ["da_orders"]
        },
        "credit_card": {
          "base_table": "outstanding_daily",
          "sql_expression": "SUM(CASE WHEN DATE_TRUNC('month', DATE(da_date)) = DATE '2024-02-01' THEN principal_outstanding * 0.01 WHEN DATE_TRUNC('month', DATE(da_date)) IS NULL THEN principal_outstanding ELSE principal_outstanding * 0.05 END)",
          "requires_join": ["da_orders"]
        },
        "khatabook": {
          "base_table": "kb_adh433",
          "sql_expression": "ABS(ROUND(SUM(CAST(leadger_balance AS DOUBLE)) / 1e7, 4))"
        },
        "da": {
          "base_table": "da_adh433",
          "sql_expression": "SUM(CAST(leadger_balance AS DOUBLE))"
        }
      }
    }
  ],
  "dimensions": [
    {
      "name": "order_type",
      "description": "Order type classification - varies by product category",
      "base_table": "varies_by_product",
      "sql_expression": "varies_by_product",
      "product_specific": {
        "bank": {
          "base_table": "nondigital_adh433_v1",
          "sql_expression": "'Bank'"
        },
        "digital": {
          "base_table": "outstanding_daily",
          "sql_expression": "CASE WHEN LOWER(order_type) = 'credin' THEN 'credin' ELSE 'Digital' END"
        },
        "credit_card": {
          "base_table": "outstanding_daily",
          "sql_expression": "'Credit Card'"
        },
        "khatabook": {
          "base_table": "kb_adh433",
          "sql_expression": "'khatabook'"
        },
        "da": {
          "base_table": "da_adh433",
          "sql_expression": "INITCAP(TRIM(partner_name))"
        }
      }
    },
    {
      "name": "region",
      "description": "Geographic region - OS (Overseas) or NE (North East)",
      "base_table": "varies_by_product",
      "sql_expression": "varies_by_product",
      "product_specific": {
        "bank": {
          "base_table": "nondigital_adh433_v1",
          "sql_expression": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs','7606/7607/7608  - enterprise development loan (buss)','term_loan_to_fi') THEN CASE WHEN branch_code = 333 THEN 'OS' ELSE 'NE' END ELSE 'NE' END"
        },
        "digital": {
          "base_table": "outstanding_daily",
          "sql_expression": "'OS'"
        },
        "credit_card": {
          "base_table": "outstanding_daily",
          "sql_expression": "'OS'"
        },
        "khatabook": {
          "base_table": "kb_adh433",
          "sql_expression": "'OS'"
        },
        "da": {
          "base_table": "da_adh433",
          "sql_expression": "'OS'"
        }
      }
    },
    {
      "name": "product_group",
      "description": "Product group classification for reporting",
      "base_table": "varies_by_product",
      "sql_expression": "varies_by_product",
      "product_specific": {
        "bank": {
          "base_table": "nondigital_adh433_v1",
          "sql_expression": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs', '7606/7607/7608  - enterprise development loan (buss)') THEN 'EDL' WHEN product_name = 'Cash Credit' THEN 'CC' WHEN lower(product_name) like '%overdraft against term deposit%' THEN 'OD/TD' WHEN lower(product_name) = 'term_loan_to_fi' THEN 'term_loan_to_fi' ELSE 'Other products' END"
        },
        "digital": {
          "base_table": "outstanding_daily",
          "sql_expression": "'Digital'"
        },
        "credit_card": {
          "base_table": "outstanding_daily",
          "sql_expression": "'Credit Card'"
        },
        "khatabook": {
          "base_table": "kb_adh433",
          "sql_expression": "'Khatabook'"
        },
        "da": {
          "base_table": "da_adh433",
          "sql_expression": "'DA'"
        }
      }
    }
  ],
  "computed_dimensions": [
    {
      "name": "bank_region",
      "description": "Region classification for Bank products based on branch code and product type",
      "base_table": "nondigital_adh433_v1",
      "sql_expression": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs','7606/7607/7608  - enterprise development loan (buss)','term_loan_to_fi') THEN CASE WHEN branch_code = 333 THEN 'OS' ELSE 'NE' END ELSE 'NE' END",
      "depends_on": ["product_name", "branch_code"]
    },
    {
      "name": "bank_product_group",
      "description": "Product group for Bank products",
      "base_table": "nondigital_adh433_v1",
      "sql_expression": "CASE WHEN LOWER(product_name) IN ('edl_migrated', 'edl_inventory', 'edl_property', 'edl rs. 5 lacs and above','edl_migrated_greater_than_5_lacs', '7606/7607/7608  - enterprise development loan (buss)') THEN 'EDL' WHEN product_name = 'Cash Credit' THEN 'CC' WHEN lower(product_name) like '%overdraft against term deposit%' THEN 'OD/TD' WHEN lower(product_name) = 'term_loan_to_fi' THEN 'term_loan_to_fi' ELSE 'Other products' END",
      "depends_on": ["product_name"]
    },
    {
      "name": "digital_order_type",
      "description": "Order type classification for Digital products",
      "base_table": "outstanding_daily",
      "sql_expression": "CASE WHEN LOWER(order_type) = 'credin' THEN 'credin' ELSE 'Digital' END",
      "depends_on": ["order_type"]
    },
    {
      "name": "da_adjusted_outstanding",
      "description": "Outstanding amount adjusted by DA factor",
      "base_table": "outstanding_daily",
      "sql_expression": "CASE WHEN DATE_TRUNC('month', DATE(da_date)) = DATE '2024-02-01' THEN principal_outstanding * 0.01 WHEN DATE_TRUNC('month', DATE(da_date)) IS NULL THEN principal_outstanding ELSE principal_outstanding * 0.05 END",
      "depends_on": ["principal_outstanding", "da_date"],
      "requires_join": ["da_orders"]
    },
    {
      "name": "khatabook_current_pos",
      "description": "Current position for Khatabook products",
      "base_table": "kb_adh433",
      "sql_expression": "ABS(ROUND(CAST(leadger_balance AS DOUBLE) / 1e7, 4))",
      "depends_on": ["leadger_balance"]
    },
    {
      "name": "da_order_type",
      "description": "Order type for DA products from partner name",
      "base_table": "da_adh433",
      "sql_expression": "INITCAP(TRIM(partner_name))",
      "depends_on": ["partner_name"]
    }
  ]
}

